<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="Matches city weather with other global cities.">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Matching Weather Cities</title>

    <!-- Add to homescreen for Chrome on Android -->
    <meta name="mobile-web-app-capable" content="yes">
    <!--<link rel="icon" sizes="192x192" href="images/touch/chrome-touch-icon-192x192.png">-->

    <!-- Add to homescreen for Safari on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Matching Weather Cities">
    <link rel="apple-touch-icon-precomposed" href="apple-touch-icon-precomposed.png">

    <!-- Tile icon for Win8 (144x144 + tile color) -->
    <meta name="msapplication-TileImage" content="images/touch/ms-touch-icon-144x144-precomposed.png">
    <meta name="msapplication-TileColor" content="#3372DF">

    <!-- SEO: If your mobile URL is different from the desktop URL, add a canonical link to the desktop page https://developers.google.com/webmasters/smartphone-sites/feature-phones -->
    <!--
    <link rel="canonical" href="http://www.example.com/">
    -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
	<script src="https://apis.google.com/js/client.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Roboto:regular,bold,italic,thin,light,bolditalic,black,medium&amp;lang=en" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="material.min.css">
    <link rel="stylesheet" href="styles.css">
    <style>
    #view-source {
      position: fixed;
      display: block;
      right: 0;
      bottom: 0;
      margin-right: 40px;
      margin-bottom: 40px;
      z-index: 900;
    }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js"></script>

	<script>
	
//	36°57'9" N  = 36.9525000
//	110°4'21" W = -110.0725000

	// convert from old-school lat/long to decimal
	function ConvertDMSToDD(degrees, minutes, seconds, direction) {
		var dd = parseInt(degrees) + parseInt(minutes)/60 + parseInt(seconds)/(60*60);

		if (direction == "S" || direction == "W") {
			dd = parseFloat(dd) * -1;
		} // Don't do anything for N or E
		return dd;
	}
	
	// parse old-school lat/long in format 36°57'9" N 110°4'21" W
	// and return decimal comma-separated lat/long.
	function ParseDMS(input) {
		var parts = input.split(/[^\d\w]+/);
		var lat = ConvertDMSToDD(parts[0], parts[1], parts[2], parts[3]);
		var lng = ConvertDMSToDD(parts[4], parts[5], parts[6], parts[7]);
		
		return lat + "," + lng;
	}
	
	//Expects [31°0\'18.0\" N], without square brackets 
	function ParseDMS2(input) {
		//var parts = input.split(/[^\d\w]+/);
		if (input != null && input !== undefined) {
			if (input.charAt(0) == "\"" && input.charAt(input.length -1) == "\"") {
				input = input.substr(1, input.length -2);
				
				input = input.replace("\"\"", "\"");
			}
			
			var split = input.split('\" '); // break off direction
			var direction = split[1];
			var split = split[0].split("\'"); // break off seconds
			var seconds = split[1];
			//console.log('degrees: ' + split[0] + ', ' + split[1] + '. match degree symbol: ' + split[0].match('\u00B0'));
			var split = split[0].split("\u00B0"); // break off minutes // THIS DEGREES SYMBOL DIDN'T WORK ON HOSTED VERSION ?
			var minutes = split[1];
			var degrees = split[0];
			
			var parsed = ConvertDMSToDD(degrees, minutes, seconds, direction);
			
			return parsed;
			
		}
		

	}
	
	var blah = ParseDMS("36°57'9\" N 110°4'21\" W");

	var parts = '31°0\'18.0\" N 121°24\'32.4\" E'.split(/[((°|'|(\"\s)|\s)\s)]/);
		
	var map;  
	
	google.maps.event.addDomListener(window, 'load', initialize);
	  
    function initialize() {
		//gapi.client.setApiKey('AIzaSyBG-MEa5wcsXp24h7h03mhSPQl2bN5gmRM');
        
	
        var mapCanvas = document.getElementById('map-canvas');
        var mapOptions = {
          center: new google.maps.LatLng(20.258028, 13.959507),
          zoom: 2,
          mapTypeId: google.maps.MapTypeId.ROADMAP
        }
        map = new google.maps.Map(mapCanvas, mapOptions)
		console.log( "ready in map initialise!" );
		
		
		google.maps.event.addListenerOnce(map, 'idle', function(){
			// do something only the first time the map is loaded
			console.log( "map has initialised!" );
			
			//gapi.client.load('urlshortener', 'v1').then(getMarkers);
			getMarkers();
		});

    }
	
	function trimResponse(response) {
		var trimmed = response.replace("google.visualization.Query.setResponse(", "");
		trimmed = trimmed.replace(");", "");
		return trimmed;
	}


	function getMarkers() {
	
		$.ajax({
			//type:"GET", // access control issue if using POST
			//url: "data/core_city_data.csv",
			url: "http://johnellliott.github.io/data/core_city_data.csv",
			dataType: 'text',
			encoding:"UTF-8",
			success: function( data) {
				//console.log(data);
				
				var lines = data.split("\n");
				//console.log(lines[4]);
				
				for (var i = 1; i < lines.length; i++) { // skip first line
					var values = lines[i].split("|");
					//console.log(values[0]);
					
					var lat = values[5]; //'31°0\'18.0\" N' 
					var lng = values[6]; //'121°24\'32.4\" E'
					
					lat = ParseDMS2(lat);
					lng = ParseDMS2(lng);
					
					var cityInfo = {
						key: values[0],
						name: values[1],
						region: values[2],
						altitude: values[3],
						country: values[4],
						type: values[7], // 1=Alpha city, 2=normal city, 3=POI
						notes: values[8],
						cityCol: values[9], // the column in the CSV row data that is associated with this city
						lat: lat,
						lng: lng,
					}
					
					citiesByRef[cityInfo.key] = cityInfo;
					citiesByIndex[cityInfo.cityCol] = cityInfo;



					createMarker(lat, lng, cityInfo, -1); // -1 means no score		
				}			

			},
			error: function( data, textStatus, errorThrown ) {
				console.log('textStatus: ' + textStatus + ', errorThrown: ' + errorThrown + ', ERROR: ', data );
			}
		});
	}

	var markerImages = [];
	
	// pass in a number from 1-10
	function createMarkerImage(size, type, selectedCity) {
		try {
			size = parseInt(size);
			if (size > 10) console.log('Error creating marker image with size ' + size);
			else if (size < 0) console.log('Error creating marker image with size ' + size);
			
			if (markerImages[size] != null) return markerImages[size];
			
			var imageSize = size * 3;
			
			var imageUrl;

			if (selectedCity) {
				imageUrl = 'images/marker-selected.png';
			} else if (size >= 9) {
				imageUrl = 'images/marker-10.png';
			} else if (size >= 8) {
				imageUrl = 'images/marker-9.png';
			} else if (size >= 7) {
				imageUrl = 'images/marker-7.png';
			} else if (size >= 6) {
				imageUrl = 'images/marker-6.png';
			} else if (size >= 5) {
				imageUrl = 'images/marker-5.png';
			} else if (size >= 4) {
				imageUrl = 'images/marker-4.png';
			} else {
				imageUrl = 'images/marker-low.png';
			} 
			
			var markerImage = {
				url: imageUrl,
				// This marker is 20 pixels wide by 32 pixels tall.
				//size: new google.maps.Size(30, 30),
				// The origin for this image is 0,0.
				origin: new google.maps.Point(0, 0),
				// Make this half of the size
				anchor: new google.maps.Point(imageSize/2, imageSize/2),
				
				scaledSize: new google.maps.Size(imageSize, imageSize)
			};
			
			markerImages[size] = markerImage;
			
			return markerImage;
		} catch(err) {
			console.log('Error creating marker image with size ' + size + '. Error: ' + err);
		}
	}
	
	/* Initialize a blank array to store all the markers
	 * that we're going to place on the map
	 */
	var markers = [];
	var markersByCityKey = {};
	 
	/* Function takes in a latitude and longitude coordinate
	 * and constructs a marker object, then pushes it on
	 * the marker array we just created.
	 */
	function createMarker(lat, lng, cityInfo, similarityScore) {
	 
		var lol = new google.maps.LatLng(lat, lng);
		
		var contentString = 
		'<div>' +
		'<h1 class="popupHeading">' + cityInfo.name + '</h1>' +
		'<div id="bodyContent">' + 
		'<p class="country">' + cityInfo.country + '</p>' + 
		'<p>' + cityInfo.notes + '</p>' +
		'<button class="mdl-button mdl-js-button mdl-button--raised mdl-button--accent btnSelectCity" id="btnSelectCity__' + cityInfo.key + '">' +
		'Select City' +
		'</button>' +
		'&nbsp;' +
		'<button class="mdl-button mdl-js-button mdl-button--primary btnWikipedia" style="float:right;" id="btnWikipedia__' + cityInfo.key + '">' +
		'Wikipedia' +
		'</button>' +		
		'</div>' +
		'</div>';

		var infowindow = new google.maps.InfoWindow({
			content: contentString
		});
		
		// pass a value between 1-10 to scale marker
		
		var size;
		
		if (similarityScore === undefined || similarityScore < 0) {
			size = 3;
		} else {
			size = parseInt(similarityScore / 10);
		}
		
		if(cityInfo.key == selectedCity) {
			var image = createMarkerImage(size, cityInfo.type, true);
		} else {
			var image = createMarkerImage(size, cityInfo.type, false);
		}
	 
		var marker = new google.maps.Marker({
			position: lol,
			icon: image,
			map: map,
			visible: true//,
			//label: cityInfo.name
		});
		
		cityInfo.marker = marker;
		cityInfo.infowindow = infowindow;
		
		google.maps.event.addListener(marker, 'click', function() {
			openInfoWindowAndBind(infowindow, marker);
		});

		markers.push(marker);
		markersByCityKey[cityInfo.key] = marker;
	}
	
	function openInfoWindowAndBind(infowindow, marker) {
		infowindow.open(map,marker);
		$(".btnSelectCity").click(function() {
			var ref = this.id.split('__')[1];
			selectCity(ref, false);
		});
		
		$(".btnWikipedia").click(function() {
			var ref = this.id.split('__')[1];
			window.open("https://en.wikipedia.org/wiki/" + ref + "#Climate", '_blank');
		});
		
		$("#btnSelectCity__" + selectedCity).prop("disabled",true);
	}
	
	// Sets the map on all markers in the array.
	function setAllMap(map) {
	  for (var i = 0; i < markers.length; i++) {
		markers[i].setMap(map);
	  }
	}

	// Removes the markers from the map, but keeps them in the array.
	function clearMarkers() {
	  setAllMap(null);
	}

	// Shows any markers currently in the array.
	function showMarkers() {
	  setAllMap(map);
	}

	// Deletes all markers in the array by removing references to them.
	function deleteMarkers() {
	  clearMarkers();
	  markers = [];
	}

	var citiesByRef = {}; // uses key e.g. Kuala_Lumpur
	var citiesByIndex = {}; // uses numeric index for city key e.g. 231
	var selectedCity;

	function selectCity(cityRef, displayInfoWindow) {
		var cityInfo = citiesByRef[cityRef];
		$("#selectedCityName").html(cityInfo.name);
		selectedCity = cityInfo.key;
		
		var cityCol = parseInt(cityInfo.cityCol);
		cityCol = cityCol+1;
		
		$.ajax({
			url: "http://johnellliott.github.io/data/disk" + cityCol + ".csv",
			dataType: 'text',
			encoding:"UTF-8",
			success: function( data) {
				//console.log(data);
				clearMarkers();
				var values = data.split("|"); // single row of weather similarity scores, split by pipe delimiter
				
				for (var i = 1; i < values.length; i++) { // skip first line
					compareCityInfo = citiesByIndex[i]; // grab the comparison city, pre-populated earlier with the matching index from the City_Col_Index column
					createMarker(compareCityInfo.lat, compareCityInfo.lng, compareCityInfo, values[i]);	
				}
				
				if (displayInfoWindow) {
					openInfoWindowAndBind(cityInfo.infowindow, cityInfo.marker);
				}
			},
			error: function( data, textStatus, errorThrown ) {
				console.log('textStatus: ' + textStatus + ', errorThrown: ' + errorThrown + ', ERROR: ', data );
			}
		});		
		
	}
	
	/* Function takes in the Bench ID and caption we constructed
	 * in $.getJSON's callback function, then creates an InfoWindow
	 * object and displays it on the map.
	 */
	function createInfoWindow(id, contentString) {
		var infowindow = new google.maps.InfoWindow({
			content: contentString
		});
	 
		google.maps.event.addListener(markers[id], 'click', function() {
			infowindow.open(map,markers[id]);
		}); 
	}
	  
	$( document ).ready(function() {
		$("#siteInfo").hide();
		$("#welcomeCard").hide(); // remove this when ready to go-live
		//$("#aboutButton").prop("disabled",true); // uncomment this
		$("#welcomeClose").click(function() {
			$("#welcomeCard").fadeOut();
			$("#aboutButton").prop("disabled",false);
		});
		$("#aboutClose").click(function() {
			$("#siteInfo").fadeOut();
			$("#aboutButton").prop("disabled",false);
		});		
		$("#aboutButton").click(function() {
			$("#siteInfo").fadeIn();
			$("#aboutButton").prop("disabled",true);
		});
		
		$("#btnSelectCity").click(function() {
			$("#siteInfo").fadeIn();
			$("#aboutButton").prop("disabled",true);
		});

		$(".cityShortcut").click(function() {
			var cityInfo = citiesByRef[this.id];
			var infowindow = cityInfo.infowindow;
			var marker = cityInfo.marker;
			openInfoWindowAndBind(infowindow, marker);
			selectCity(this.id, true);
			
		});
	});
    </script>	

  </head>
  <body>
    <div class="demo-layout mdl-layout mdl-js-layout mdl-layout--fixed-drawer mdl-layout--fixed-header">
      <header class="demo-header mdl-layout__header mdl-color--white mdl-color--grey-100 mdl-color-text--grey-600" id="customHeader">
        <div class="mdl-layout__header-row">
          <span class="mdl-layout-title" id="locationTitle">MWC</span>
          <div class="mdl-layout-spacer"></div>
		  <span class="mdl-layout-title" id="selectedCityName">None</span> 
		  <div>&nbsp;&nbsp;&nbsp;</div>
          <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" id="hdrbtn">
            <i class="material-icons">location_searching</i>
          </button>
          <ul class="mdl-menu mdl-js-menu mdl-js-ripple-effect mdl-menu--bottom-right" for="hdrbtn">
			<li class="mdl-menu__item cityShortcut" id="Abu_Dhabi">Abu Dhabi</li>
			<li class="mdl-menu__item cityShortcut" id="Chicago">Chicago</li>
			<li class="mdl-menu__item cityShortcut" id="Hong_Kong">Hong Kong</li>
			<li class="mdl-menu__item cityShortcut" id="London">London</li>
			<li class="mdl-menu__item cityShortcut" id="Los_Angeles">Los Angeles</li>
			<li class="mdl-menu__item cityShortcut" id="Buenos_Aires">Buenos Aires</li>
			<li class="mdl-menu__item cityShortcut" id="Sao_Paulo">Singapore</li>
			<li class="mdl-menu__item cityShortcut" id="Tokyo">Tokyo</li>
			
			
			
			
          </ul>
        </div>
      </header>
	  

      <main class="mdl-layout__content mdl-color--grey-100" id="customMain">
		<div id="map-canvas"></div>
      </main>
    </div>
      <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" style="position: fixed; left: -1000px; height: -1000px;">
        <defs>
          <mask id="piemask" maskContentUnits="objectBoundingBox">
            <circle cx=0.5 cy=0.5 r=0.49 fill="white" />
            <circle cx=0.5 cy=0.5 r=0.40 fill="black" />
          </mask>
          <g id="piechart">
            <circle cx=0.5 cy=0.5 r=0.5 />
            <path d="M 0.5 0.5 0.5 0 A 0.5 0.5 0 0 1 0.95 0.28 z" stroke="none" fill="rgba(255, 255, 255, 0.75)" />
          </g>
        </defs>
      </svg>
      <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 250" style="position: fixed; left: -1000px; height: -1000px;">
        <defs>
          <g id="chart">
            <g id="Gridlines">
              <line fill="#888888" stroke="#888888" stroke-miterlimit="10" x1="0" y1="27.3" x2="468.3" y2="27.3"/>
              <line fill="#888888" stroke="#888888" stroke-miterlimit="10" x1="0" y1="66.7" x2="468.3" y2="66.7"/>
              <line fill="#888888" stroke="#888888" stroke-miterlimit="10" x1="0" y1="105.3" x2="468.3" y2="105.3"/>
              <line fill="#888888" stroke="#888888" stroke-miterlimit="10" x1="0" y1="144.7" x2="468.3" y2="144.7"/>
              <line fill="#888888" stroke="#888888" stroke-miterlimit="10" x1="0" y1="184.3" x2="468.3" y2="184.3"/>
            </g>
            <g id="Numbers">
              <text transform="matrix(1 0 0 1 485 29.3333)" fill="#888888" font-family="'Roboto'" font-size="9">500</text>
              <text transform="matrix(1 0 0 1 485 69)" fill="#888888" font-family="'Roboto'" font-size="9">400</text>
              <text transform="matrix(1 0 0 1 485 109.3333)" fill="#888888" font-family="'Roboto'" font-size="9">300</text>
              <text transform="matrix(1 0 0 1 485 149)" fill="#888888" font-family="'Roboto'" font-size="9">200</text>
              <text transform="matrix(1 0 0 1 485 188.3333)" fill="#888888" font-family="'Roboto'" font-size="9">100</text>
              <text transform="matrix(1 0 0 1 0 249.0003)" fill="#888888" font-family="'Roboto'" font-size="9">1</text>
              <text transform="matrix(1 0 0 1 78 249.0003)" fill="#888888" font-family="'Roboto'" font-size="9">2</text>
              <text transform="matrix(1 0 0 1 154.6667 249.0003)" fill="#888888" font-family="'Roboto'" font-size="9">3</text>
              <text transform="matrix(1 0 0 1 232.1667 249.0003)" fill="#888888" font-family="'Roboto'" font-size="9">4</text>
              <text transform="matrix(1 0 0 1 309 249.0003)" fill="#888888" font-family="'Roboto'" font-size="9">5</text>
              <text transform="matrix(1 0 0 1 386.6667 249.0003)" fill="#888888" font-family="'Roboto'" font-size="9">6</text>
              <text transform="matrix(1 0 0 1 464.3333 249.0003)" fill="#888888" font-family="'Roboto'" font-size="9">7</text>
            </g>
            <g id="Layer_5">
              <polygon opacity="0.36" stroke-miterlimit="10" points="0,223.3 48,138.5 154.7,169 211,88.5
              294.5,80.5 380,165.2 437,75.5 469.5,223.3 	"/>
            </g>
            <g id="Layer_4">
              <polygon stroke-miterlimit="10" points="469.3,222.7 1,222.7 48.7,166.7 155.7,188.3 212,132.7
              296.7,128 380.7,184.3 436.7,125 	"/>
            </g>
          </g>
        </defs>
      </svg>
	  <button id="aboutButton" class="mdl-button mdl-js-button mdl-button--fab mdl-button--colored">
		  <i class="material-icons">info_outline</i>
	  </button>
	 
		<div class="mdl-card mdl-shadow--2dp demo-card-wide" id="welcomeCard">
		  <div class="mdl-card__title">
			<h2 class="mdl-card__title-text">Welcome</h2>
		  </div>
		  <div class="mdl-card__supporting-text">
			Welcome to <b>Matching Weather Cities</b>. Pick a city to find other cities with similar weather.
		  </div>
		  <div class="mdl-card__actions mdl-card--border">
			<a class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect" id="welcomeClose">
			  Let's Go
			</a>
		  </div>
		  <div class="mdl-card__menu">
			<!--<button class="mdl-button mdl-button--icon mdl-js-button mdl-js-ripple-effect">
			  <i class="material-icons">share</i>
			</button>-->
		  </div>
		</div>	  
		
		<div class="mdl-card mdl-shadow--2dp demo-card-wide" id="siteInfo">
		  <div class="mdl-card__supporting-text">
			<code>
			/**<br/>
			 *<br/>
			 * <b>Matching Weather Cities</b><br/>
			 *<br/>	
			 * Weather data grabbed using the Java<br/> 
			 * library <a href="http://jsoup.org/" target="_blank">jsoup</a>. Predictive modelling<br/>
			 * of location weather similarity done<br/>
			 * using <a href="https://www.r-project.org/about.html">R</a>. Web app written in HTML,<br/>
			 * jQuery and using Google API. Site<br/>
			 * hosted on <a href="https://github.com/">Github</a>.<br/>
			 *<br/>
			 *<br/>	
			 * Weather is matched on temperature,<br/> 
			 * rainfall, humidity, and climate<br/>
			 * classification. Variables are<br/>
			 * matched based on mean, variance,<br/>
			 * maxima and minima and seasonality<br/>
			 * via multivariate modelling.<br/>		
			 * <br/>
			 * By <a href="https://au.linkedin.com/in/johnrobertelliott" target="_blank">John Elliott</a><br/>
			 *<br/>			 
			 */<br/>
			</code>
		  </div>
		  <div class="mdl-card__actions mdl-card--border">
			<a class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect" id="aboutClose">
			  Close
			</a>
		  </div>
		  <div class="mdl-card__menu">
			<!--<button class="mdl-button mdl-button--icon mdl-js-button mdl-js-ripple-effect">
			  <i class="material-icons">share</i>
			</button>-->
		  </div>
		</div>	  		
	  
	  <script src="material.min.js"></script>
	  <script>
		  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

		  ga('create', 'UA-65946158-1', 'auto');
		  ga('send', 'pageview');

	  </script>
  </body>
</html>
