function ConvertDMSToDD(degrees,minutes,seconds,direction){var dd=parseInt(degrees)+parseInt(minutes)/60+parseInt(seconds)/(60*60);if(direction=="S"||direction=="W"){dd=parseFloat(dd)*-1;}
return dd;}
function ParseDMS2(input){if(input!=null&&input!==undefined){if(input.charAt(0)=="\""&&input.charAt(input.length-1)=="\""){input=input.substr(1,input.length-2);input=input.replace("\"\"","\"");}
var split=input.split('\" ');var direction=split[1];var split=split[0].split("\'");var seconds=split[1];var split=split[0].split("\u00B0");var minutes=split[1];var degrees=split[0];var parsed=ConvertDMSToDD(degrees,minutes,seconds,direction);return parsed;}}
var parts='31°0\'18.0\" N 121°24\'32.4\" E'.split(/[((°|'|(\"\s)|\s)\s)]/);var map;var heatmap;google.maps.event.addDomListener(window,'load',initialize);function initialize(){var mapCanvas=document.getElementById('map-canvas');var mapOptions={center:new google.maps.LatLng(20.258028,13.959507),zoom:2,mapTypeId:google.maps.MapTypeId.ROADMAP}
map=new google.maps.Map(mapCanvas,mapOptions)
console.log("ready in map initialise!");google.maps.event.addListenerOnce(map,'idle',function(){console.log("map has initialised!");getMarkers();});}
function trimResponse(response){var trimmed=response.replace("google.visualization.Query.setResponse(","");trimmed=trimmed.replace(");","");return trimmed;}
function getMarkers(){$.ajax({url:"http://johnellliott.github.io/data/core_city_data.csv",dataType:'text',encoding:"UTF-8",success:function(data){var lines=data.split("\n");for(var i=1;i<lines.length;i++){var values=lines[i].split("|");if(values[5]===undefined||values[6]===undefined||values[11]===undefined||values[14]===undefined){console.log('Missing data for city '+values[0]);continue;}
var rainfall=parseInt(values[14]);if(rainfall==0)continue;var lat=values[5];var lng=values[6];lat=ParseDMS2(lat);lng=ParseDMS2(lng);var cityInfo={key:values[0],name:values[1],region:values[2],altitude:values[3],country:values[4],type:values[7],notes:values[8],cityCol:values[9],aht:values[11],ahtMax:values[12],ahtMin:values[13],arTotal:values[14],lat:lat,lng:lng,}
citiesByRef[cityInfo.key]=cityInfo;citiesByIndex[cityInfo.cityCol]=cityInfo;createMarker(lat,lng,cityInfo,-1,true);}
selectCity("Barcelona",false,false);},error:function(data,textStatus,errorThrown){console.log('textStatus: '+textStatus+', errorThrown: '+errorThrown+', ERROR: ',data);}});}
var markerImages=[];function createMarkerImage(size,type,selectedCity,fixedSize){try{size=parseFloat(size);if(size>10)console.log('Error creating marker image with size '+size);else if(size<0)console.log('Error creating marker image with size '+size);if(markerImages[size]!=null)return markerImages[size];var imageSize=size*3;var imageUrl;if(fixedSize){imageUrl='images/marker-transparent.png';}else{if(selectedCity){imageUrl='images/marker-selected.png';imageSize=imageSize*2;}else if(size>=9.5){imageUrl='images/marker-10.png';}else if(size>=9){imageUrl='images/marker-9.png';}else if(size>=8.5){imageUrl='images/marker-8.png';}else if(size>=8){imageUrl='images/marker-7.png';}else if(size>=7){imageUrl='images/marker-6.png';}else if(size>=6){imageUrl='images/marker-5.png';}else if(size>=5){imageUrl='images/marker-4.png';}else if(size>=4){imageUrl='images/marker-3.png';}else{imageUrl='images/marker-low.png';}}
size=parseInt(size);var markerImage={url:imageUrl,origin:new google.maps.Point(0,0),anchor:new google.maps.Point(imageSize/2,imageSize/2),scaledSize:new google.maps.Size(imageSize,imageSize)};markerImages[size]=markerImage;return markerImage;}catch(err){console.log('Error creating marker image with size '+size+'. Error: '+err);}}
var markers=[];var markersByCityKey={};function createMarker(lat,lng,cityInfo,similarityScore,fixedSize){var lol=new google.maps.LatLng(lat,lng);var contentString='<div class="markerPopup">'+'<h1 class="popupHeading">'+cityInfo.name+'</h1>'+'<div id="bodyContent">'+'<p class="country">'+cityInfo.country+'</p>'+'<p>'+cityInfo.notes+'</p>'+
tempFactsHTML(cityInfo.aht,cityInfo.ahtMax,cityInfo.ahtMin,cityInfo.arTotal)+'<div>'+'<button class="mdl-button mdl-js-button mdl-button--raised mdl-button--accent btnSelectCity" id="btnSelectCity__'+cityInfo.key+'">'+'Select City'+'</button>'+'&nbsp;'+'<button class="mdl-button mdl-js-button mdl-button--primary btnWikipedia" style="float:right;" id="btnWikipedia__'+cityInfo.key+'">'+'Wikipedia'+'</button>'+'</div>'+'</div>'+
renderScore(similarityScore)+'</div>';var infowindow=new google.maps.InfoWindow({content:contentString});var size;if(fixedSize)
similarityScore=20;if(similarityScore===undefined||similarityScore<0){size=3;}else{size=similarityScore/10;}
if(cityInfo.key==selectedCity){var image=createMarkerImage(size,cityInfo.type,true,fixedSize);}else{var image=createMarkerImage(size,cityInfo.type,false,fixedSize);}
var marker=new google.maps.Marker({position:lol,icon:image,map:map,visible:true});cityInfo.marker=marker;cityInfo.infowindow=infowindow;google.maps.event.addListener(marker,'click',function(){openInfoWindowAndBind(infowindow,marker);});markers.push(marker);markersByCityKey[cityInfo.key]=marker;}
function renderScore(similarityScore){var html="";html=html+"<span class='similarityScore'><span class='val'>"+similarityScore+"</span></span>";return html;}
function tempFactsHTML(aht,ahtMax,ahtMin,arTotal){if(!isNumeric(aht))aht="";if(!isNumeric(ahtMax))ahtMax="";if(!isNumeric(ahtMin))ahtMin="";if(!isNumeric(arTotal))arTotal="";aht=parseInt(aht);ahtMax=parseInt(ahtMax);ahtMin=parseInt(ahtMin);arTotal=parseInt(arTotal);var html="<div class='weatherFacts'>";html=html+"<div><span class='tempFactLabel'>";html=html+"Mean daytime (°C):";html=html+"</span>";html=html+"<span class='tempFactValue' style='background-color:"+getTempColour(aht)+"'>";html=html+aht;html=html+"</span></div>";html=html+"<div><span class='tempFactLabel'>";html=html+"Max. daytime (°C):";html=html+"</span>";html=html+"<span class='tempFactValue' style='background-color:"+getTempColour(ahtMax)+"'>";html=html+ahtMax;html=html+"</span></div>";html=html+"<div><span class='tempFactLabel'>";html=html+"Min. daytime (°C):";html=html+"</span>";html=html+"<span class='tempFactValue' style='background-color:"+getTempColour(ahtMin)+"'>";html=html+ahtMin;html=html+"</span></div>";html=html+"<div><span class='tempFactLabel'>";html=html+"Annual rainfall (mm):";html=html+"</span>";html=html+"<span class='tempFactValue' style='background-color:"+getRainColour(arTotal)+"'>";html=html+arTotal;html=html+"</span></div>";html=html+"</div>";return html;}
function getTempColour(temp){if(temp>35)return"#ff0000";else if(temp>30)return"#ff4800";else if(temp>25)return"#ff8400";else if(temp>20)return"#ffd200";else if(temp>15)return"#deff00";else if(temp>10)return"#aeff00";else if(temp>5)return"#0cff00";else if(temp>0)return"#00ff72";else if(temp>-5)return"#00ffd8";else if(temp>-10)return"#00c6ff";else if(temp>-20)return"#007eff";else if(temp>-30)return"#001eff";}
function getRainColour(rainfall){if(rainfall>3000)return"#359a32";else if(rainfall>2500)return"#47b244";else if(rainfall>2000)return"#4fbd4c";else if(rainfall>1500)return"#5bc958";else if(rainfall>1000)return"#6edc6b";else if(rainfall>700)return"#86ed84";else if(rainfall>500)return"#99f597";else if(rainfall>250)return"#b5fbb3";else if(rainfall>=0)return"#daffd9";}
function isNumeric(n){return!isNaN(parseFloat(n))&&isFinite(n);}
function openInfoWindowAndBind(infowindow,marker){infowindow.open(map,marker);$(".btnSelectCity").click(function(){var ref=this.id.split('__')[1];selectCity(ref,false,true);});$(".btnWikipedia").click(function(){var ref=this.id.split('__')[1];window.open("https://en.wikipedia.org/wiki/"+ref+"#Climate",'_blank');});var similarityScore=parseInt($(".similarityScore .val").text());if(similarityScore>0){$(".similarityScore").show();$(".similarityScore").css("background-color",getScoreCircleColor(similarityScore));$(".similarityScore").css("color",getScoreCircleColorFont(similarityScore));if(similarityScore>=100)
$(".similarityScore .val").css("left","6px");else
$(".similarityScore .val").css("left","10px");}else{$(".similarityScore").hide();}
$("#btnSelectCity__"+selectedCity).prop("disabled",true);}
function getScoreCircleColor(similarityScore){if(similarityScore>=95){return"#ed1c1c";}else if(similarityScore>=90){return"#ed1c1c";}else if(similarityScore>=85){return"#ed531c";}else if(similarityScore>=80){return"#ed8d1c";}else if(similarityScore>=70){return"#edbf1c";}else if(similarityScore>=60){return"#ebed1c";}else if(similarityScore>=50){return"#baed1c";}else if(similarityScore>=40){return"#c1f030";}else if(similarityScore>=30){return"#a3bd50";}else{return"#898989";}}
function getScoreCircleColorFont(similarityScore){if(similarityScore>=95){return"white";}else{return"black";}}
function setAllMap(map){for(var i=0;i<markers.length;i++){markers[i].setMap(map);}}
function clearMarkers(){setAllMap(null);}
function showMarkers(){setAllMap(map);}
function deleteMarkers(){clearMarkers();markers=[];}
var citiesByRef={};var citiesByIndex={};var selectedCity;var heatmapMode=false;var africaMatches={};var asiaMatches={};var europeMatches={};var naMatches={};var saMatches={};function initHeatmap(data){heatmap=new google.maps.visualization.HeatmapLayer({data:getPoints(),map:map});}
function selectCity(cityRef,displayInfoWindow,displayMatchWindow){var cityInfo=citiesByRef[cityRef];var cityName=cityInfo.name.split(",")[0];$("#selectedCityName").html(cityName);selectedCity=cityInfo.key;var cityCol=parseInt(cityInfo.cityCol);cityCol=cityCol+1;$.ajax({url:"http://johnellliott.github.io/data/disk"+cityCol+".csv",dataType:'text',encoding:"UTF-8",success:function(data){clearMarkers();africaMatches={};asiaMatches={};europeMatches={};naMatches={};saMatches={};var values=data.split("|");var heatmapPoints=[];for(var i=1;i<values.length;i++){compareCityInfo=citiesByIndex[i];if(compareCityInfo!==undefined){compareCityInfo.score=values[i];if(heatmapMode){createMarker(compareCityInfo.lat,compareCityInfo.lng,compareCityInfo,values[i],true);var weight=values[i]/10;heatmapPoints[i]={location:new google.maps.LatLng(compareCityInfo.lat,compareCityInfo.lng),weight:weight};}else{createMarker(compareCityInfo.lat,compareCityInfo.lng,compareCityInfo,values[i],false);}
if(compareCityInfo.region=="Africa"||compareCityInfo.region=="Central Asia"){groupRegionCounter(africaMatches,compareCityInfo,values[i])}else if(compareCityInfo.region=="South-East Asia"||compareCityInfo.region=="North-East Asia"||compareCityInfo.region=="South Asia"){groupRegionCounter(asiaMatches,compareCityInfo,values[i])}else if(compareCityInfo.region=="Europe"){groupRegionCounter(europeMatches,compareCityInfo,values[i])}else if(compareCityInfo.region=="North America"){groupRegionCounter(naMatches,compareCityInfo,values[i])}else if(compareCityInfo.region=="South America"){groupRegionCounter(saMatches,compareCityInfo,values[i])}}}
if(heatmapMode){heatmap=new google.maps.visualization.HeatmapLayer({data:heatmapPoints,dissipating:true,maxIntensity:10,radius:15,radius:15,map:map});}
$('#cityMatchInfo').prop("disabled",false);if(displayInfoWindow){openInfoWindowAndBind(cityInfo.infowindow,cityInfo.marker);}else if(displayMatchWindow){openMatchInfo(selectedCity);}},error:function(data,textStatus,errorThrown){console.log('textStatus: '+textStatus+', errorThrown: '+errorThrown+', ERROR: ',data);}});}
function groupRegionCounter(regionMatchingObject,compareCityInfo,score){var cityGroup=[];if(regionMatchingObject[score]!=null){cityGroup=regionMatchingObject[score];}
if(compareCityInfo.key!=selectedCity)
cityGroup.push(compareCityInfo);regionMatchingObject[score]=cityGroup;}
function createInfoWindow(id,contentString){var infowindow=new google.maps.InfoWindow({content:contentString});google.maps.event.addListener(markers[id],'click',function(){infowindow.open(map,markers[id]);});}
function createCityMatchRow(cityInfo,prefix,rowNumber){$('#'+prefix+'Row'+rowNumber).html('<td class="mdl-data-table__cell--non-numeric">'+cityInfo.name+'</td><td>'+cityInfo.score+'</td><td style="display:none;" id="'+prefix+'Row'+rowNumber+'Key">'+cityInfo.key+'</td>');}
function findTopMatches(regionArray,regionName){var limit=3;var found=[];for(var i=100;i>0;i--){cityGroup=regionArray[i];if(cityGroup!=null){for(var j=0;j<cityGroup.length;j++){cityInfo=cityGroup[j];found.push(cityInfo);createCityMatchRow(cityInfo,regionName,found.length)
if(found.length>3){return found;}}}}}
function openCity(cityInfo){var infowindow=cityInfo.infowindow;var marker=cityInfo.marker;selectCity(cityInfo.key,false,true);var latLng=marker.getPosition();map.setCenter(latLng);}
function openMatchInfo(cityKey){$("#welcomeCard").hide();var cityInfo=citiesByRef[selectedCity];$('#cityName').html(cityInfo.name);findTopMatches(africaMatches,"africa");findTopMatches(asiaMatches,"asia");findTopMatches(europeMatches,"europe");findTopMatches(naMatches,"na");findTopMatches(saMatches,"sa");$(".matchInfoAsia.data").hide();$(".matchInfoAfrica.data").hide();$(".matchInfoEurope.data").hide();$(".matchInfoNA.data").hide();$(".matchInfoSA.data").hide();$('#matchInfo').fadeIn();}
function getParameterByName(name){name=name.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var regex=new RegExp("[\\?&]"+name+"=([^&#]*)"),results=regex.exec(location.search);return results===null?"":decodeURIComponent(results[1].replace(/\+/g," "));}
$(document).ready(function(){$('.cityRow').click(function(){var row=$(this).attr('id');$("#"+row+"Key").text();var clickedKey=$("#"+row+"Key").text();var cityInfo=citiesByRef[clickedKey];$('#matchInfo').fadeOut();openCity(cityInfo);});$('#cityMatchInfo').prop("disabled",true);$('#cityMatchInfo').click(function(){openMatchInfo(selectedCity);});$("#matchInfoClose").click(function(){$('#matchInfo').fadeOut();});$(".matchInfoAsia.header").click(function(){$(".matchInfoAsia.data").toggle();$(".matchInfoAfrica.data").hide();$(".matchInfoEurope.data").hide();$(".matchInfoNA.data").hide();$(".matchInfoSA.data").hide();});$(".matchInfoAfrica.header").click(function(){$(".matchInfoAsia.data").hide();$(".matchInfoAfrica.data").toggle();$(".matchInfoEurope.data").hide();$(".matchInfoNA.data").hide();$(".matchInfoSA.data").hide();});$(".matchInfoEurope.header").click(function(){$(".matchInfoAsia.data").hide();$(".matchInfoAfrica.data").hide();$(".matchInfoEurope.data").toggle();$(".matchInfoNA.data").hide();$(".matchInfoSA.data").hide();});$(".matchInfoNA.header").click(function(){$(".matchInfoAsia.data").hide();$(".matchInfoAfrica.data").hide();$(".matchInfoEurope.data").hide();$(".matchInfoNA.data").toggle();$(".matchInfoSA.data").hide();});$(".matchInfoSA.header").click(function(){$(".matchInfoAsia.data").hide();$(".matchInfoAfrica.data").hide();$(".matchInfoEurope.data").hide();$(".matchInfoNA.data").hide();$(".matchInfoSA.data").toggle();});});